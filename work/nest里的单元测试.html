<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nest里的单元测试 | Heal Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Oops!">
    
    <link rel="preload" href="/assets/css/0.styles.9aec748c.css" as="style"><link rel="preload" href="/assets/js/app.251be91f.js" as="script"><link rel="preload" href="/assets/js/3.c83a7086.js" as="script"><link rel="preload" href="/assets/js/133.0af77430.js" as="script"><link rel="prefetch" href="/assets/js/10.9b4b1c5b.js"><link rel="prefetch" href="/assets/js/100.71d07cef.js"><link rel="prefetch" href="/assets/js/101.179111e2.js"><link rel="prefetch" href="/assets/js/102.fb2b88f1.js"><link rel="prefetch" href="/assets/js/103.7568d2c9.js"><link rel="prefetch" href="/assets/js/104.e3af40c6.js"><link rel="prefetch" href="/assets/js/105.02947bd1.js"><link rel="prefetch" href="/assets/js/106.215fa471.js"><link rel="prefetch" href="/assets/js/107.347020e8.js"><link rel="prefetch" href="/assets/js/108.a74a9d5c.js"><link rel="prefetch" href="/assets/js/109.588efe56.js"><link rel="prefetch" href="/assets/js/11.33d20895.js"><link rel="prefetch" href="/assets/js/110.6bf0cd15.js"><link rel="prefetch" href="/assets/js/111.56872705.js"><link rel="prefetch" href="/assets/js/112.79a49d68.js"><link rel="prefetch" href="/assets/js/113.d2d148ce.js"><link rel="prefetch" href="/assets/js/114.7b4680c2.js"><link rel="prefetch" href="/assets/js/115.456a079c.js"><link rel="prefetch" href="/assets/js/116.a69940ce.js"><link rel="prefetch" href="/assets/js/117.358ff765.js"><link rel="prefetch" href="/assets/js/118.e0e777c3.js"><link rel="prefetch" href="/assets/js/119.0534aeda.js"><link rel="prefetch" href="/assets/js/12.b0af3da4.js"><link rel="prefetch" href="/assets/js/120.87d15838.js"><link rel="prefetch" href="/assets/js/121.dea763c1.js"><link rel="prefetch" href="/assets/js/122.c9084785.js"><link rel="prefetch" href="/assets/js/123.0233e04d.js"><link rel="prefetch" href="/assets/js/124.687e7d34.js"><link rel="prefetch" href="/assets/js/125.48b00fdf.js"><link rel="prefetch" href="/assets/js/126.1c866d56.js"><link rel="prefetch" href="/assets/js/127.9b995b2b.js"><link rel="prefetch" href="/assets/js/128.1e15c696.js"><link rel="prefetch" href="/assets/js/129.f6f7e357.js"><link rel="prefetch" href="/assets/js/13.d5dc2fab.js"><link rel="prefetch" href="/assets/js/130.dee8ae7d.js"><link rel="prefetch" href="/assets/js/131.0b92dd0d.js"><link rel="prefetch" href="/assets/js/132.7703318d.js"><link rel="prefetch" href="/assets/js/134.e31ad7f7.js"><link rel="prefetch" href="/assets/js/14.fff65a91.js"><link rel="prefetch" href="/assets/js/15.9f7842fa.js"><link rel="prefetch" href="/assets/js/16.6a5ec5c5.js"><link rel="prefetch" href="/assets/js/17.18aef6b8.js"><link rel="prefetch" href="/assets/js/18.6c9daf76.js"><link rel="prefetch" href="/assets/js/19.037e3605.js"><link rel="prefetch" href="/assets/js/2.192bc844.js"><link rel="prefetch" href="/assets/js/20.7ab09a07.js"><link rel="prefetch" href="/assets/js/21.c71d3cb4.js"><link rel="prefetch" href="/assets/js/22.f21171e1.js"><link rel="prefetch" href="/assets/js/23.704c4922.js"><link rel="prefetch" href="/assets/js/24.fe8d0514.js"><link rel="prefetch" href="/assets/js/25.57206a35.js"><link rel="prefetch" href="/assets/js/26.8c3c29a3.js"><link rel="prefetch" href="/assets/js/27.5cd06428.js"><link rel="prefetch" href="/assets/js/28.7e74b732.js"><link rel="prefetch" href="/assets/js/29.6b1b7028.js"><link rel="prefetch" href="/assets/js/30.e999d743.js"><link rel="prefetch" href="/assets/js/31.9e30de7f.js"><link rel="prefetch" href="/assets/js/32.274a7c8f.js"><link rel="prefetch" href="/assets/js/33.773cd7fd.js"><link rel="prefetch" href="/assets/js/34.c872d204.js"><link rel="prefetch" href="/assets/js/35.ac4979f0.js"><link rel="prefetch" href="/assets/js/36.0d52145c.js"><link rel="prefetch" href="/assets/js/37.e6ae99e4.js"><link rel="prefetch" href="/assets/js/38.cc5eb353.js"><link rel="prefetch" href="/assets/js/39.7860f77a.js"><link rel="prefetch" href="/assets/js/4.c5d0d5d1.js"><link rel="prefetch" href="/assets/js/40.9598c31b.js"><link rel="prefetch" href="/assets/js/41.6dba571a.js"><link rel="prefetch" href="/assets/js/42.aaf0a3b1.js"><link rel="prefetch" href="/assets/js/43.75d56bc5.js"><link rel="prefetch" href="/assets/js/44.1806bd92.js"><link rel="prefetch" href="/assets/js/45.fb488eb4.js"><link rel="prefetch" href="/assets/js/46.9719aeab.js"><link rel="prefetch" href="/assets/js/47.5d1f7ce6.js"><link rel="prefetch" href="/assets/js/48.40748c60.js"><link rel="prefetch" href="/assets/js/49.13f4aa8e.js"><link rel="prefetch" href="/assets/js/5.2a51231d.js"><link rel="prefetch" href="/assets/js/50.77794051.js"><link rel="prefetch" href="/assets/js/51.788e8927.js"><link rel="prefetch" href="/assets/js/52.e19f54b5.js"><link rel="prefetch" href="/assets/js/53.34a7496b.js"><link rel="prefetch" href="/assets/js/54.20eb5f70.js"><link rel="prefetch" href="/assets/js/55.c2cefb16.js"><link rel="prefetch" href="/assets/js/56.1c7afe9b.js"><link rel="prefetch" href="/assets/js/57.f47af290.js"><link rel="prefetch" href="/assets/js/58.1360df82.js"><link rel="prefetch" href="/assets/js/59.284dcf4b.js"><link rel="prefetch" href="/assets/js/6.f256a2e9.js"><link rel="prefetch" href="/assets/js/60.be120a90.js"><link rel="prefetch" href="/assets/js/61.1c25bc60.js"><link rel="prefetch" href="/assets/js/62.b1efa100.js"><link rel="prefetch" href="/assets/js/63.daebacb7.js"><link rel="prefetch" href="/assets/js/64.daaa059a.js"><link rel="prefetch" href="/assets/js/65.39572620.js"><link rel="prefetch" href="/assets/js/66.65601522.js"><link rel="prefetch" href="/assets/js/67.784af14b.js"><link rel="prefetch" href="/assets/js/68.b6359956.js"><link rel="prefetch" href="/assets/js/69.4bad2540.js"><link rel="prefetch" href="/assets/js/7.68f294b2.js"><link rel="prefetch" href="/assets/js/70.a97b3aa3.js"><link rel="prefetch" href="/assets/js/71.9687c68d.js"><link rel="prefetch" href="/assets/js/72.651f75d2.js"><link rel="prefetch" href="/assets/js/73.63d00407.js"><link rel="prefetch" href="/assets/js/74.ccacf2a6.js"><link rel="prefetch" href="/assets/js/75.cf1a3e61.js"><link rel="prefetch" href="/assets/js/76.7496d985.js"><link rel="prefetch" href="/assets/js/77.7085151b.js"><link rel="prefetch" href="/assets/js/78.3bf03409.js"><link rel="prefetch" href="/assets/js/79.b9838f57.js"><link rel="prefetch" href="/assets/js/8.aa24b4c3.js"><link rel="prefetch" href="/assets/js/80.a2289481.js"><link rel="prefetch" href="/assets/js/81.934c5bb1.js"><link rel="prefetch" href="/assets/js/82.6e3524a5.js"><link rel="prefetch" href="/assets/js/83.44d532e1.js"><link rel="prefetch" href="/assets/js/84.afea3ab4.js"><link rel="prefetch" href="/assets/js/85.113b5e96.js"><link rel="prefetch" href="/assets/js/86.2b2e53a7.js"><link rel="prefetch" href="/assets/js/87.d6dfa7c3.js"><link rel="prefetch" href="/assets/js/88.5f01c603.js"><link rel="prefetch" href="/assets/js/89.b37d4a1e.js"><link rel="prefetch" href="/assets/js/9.67cdab75.js"><link rel="prefetch" href="/assets/js/90.0c9617d2.js"><link rel="prefetch" href="/assets/js/91.bcc5a91b.js"><link rel="prefetch" href="/assets/js/92.08ccb932.js"><link rel="prefetch" href="/assets/js/93.f43d0923.js"><link rel="prefetch" href="/assets/js/94.40df7cf8.js"><link rel="prefetch" href="/assets/js/95.9b4a0dca.js"><link rel="prefetch" href="/assets/js/96.3c4a168b.js"><link rel="prefetch" href="/assets/js/97.d14f2da0.js"><link rel="prefetch" href="/assets/js/98.9cf6016e.js"><link rel="prefetch" href="/assets/js/99.980a7b6e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9aec748c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Heal Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/about.html" class="sidebar-link">介绍</a></li><li><section class="sidebar-group depth-0"><a href="/work/" class="sidebar-heading clickable router-link-active open"><span>工作</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/work/入职.html" class="sidebar-link">入职</a></li><li><a href="/work/nest里的单元测试.html" class="active sidebar-link">nest里的单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/work/nest里的单元测试.html#测试是什么" class="sidebar-link">测试是什么</a></li><li class="sidebar-sub-header"><a href="/work/nest里的单元测试.html#例子" class="sidebar-link">例子</a></li></ul></li><li><a href="/work/single-spa.html" class="sidebar-link">single-spa浅析</a></li><li><a href="/work/qiankun特性源码分析.html" class="sidebar-link">qiankun特性分析</a></li><li><a href="/work/markdown转ppt.html" class="sidebar-link">Markdowm转ppt</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/tools/" class="sidebar-heading clickable"><span>工具</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tools/约定式路由插件.html" class="sidebar-link">约定式路由插件</a></li><li><a href="/tools/组件替换工具.html" class="sidebar-link">组件替换工具</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/css/" class="sidebar-heading clickable"><span>css</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/css/bfc.html" class="sidebar-link">BFC</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/algorithm/" class="sidebar-heading clickable"><span>LeetCode题解</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/algorithm/2020-05/" class="sidebar-heading clickable open"><span>2020-05</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/algorithm/2020-05/2020-05-11.html" class="sidebar-link">2020/5/11 No.50 Pow(x,n)</a></li><li><a href="/algorithm/2020-05/2020-05-12.html" class="sidebar-link">2020/5/12 No.155 最小栈</a></li><li><a href="/algorithm/2020-05/2020-05-13.html" class="sidebar-link">2020/5/13 No.102 二叉树的层序遍历</a></li><li><a href="/algorithm/2020-05/2020-05-14.html" class="sidebar-link">2020/5/14 No.136 只出现一次的数字</a></li><li><a href="/algorithm/2020-05/2020-05-15.html" class="sidebar-link">2020/5/15 No.560 和为K的子数组</a></li><li><a href="/algorithm/2020-05/2020-05-16.html" class="sidebar-link">2020/5/16 No.25 K个一组翻转链表</a></li><li><a href="/algorithm/2020-05/2020-05-17.html" class="sidebar-link">2020/5/17 No.210 课程表II</a></li><li><a href="/algorithm/2020-05/2020-05-18.html" class="sidebar-link">2020/5/18 No.152 乘积最大的子数组</a></li><li><a href="/algorithm/2020-05/2020-05-19.html" class="sidebar-link">2020/5/19 No.680 验证回文字符串 Ⅱ</a></li><li><a href="/algorithm/2020-05/2020-05-20.html" class="sidebar-link">2020/5/20 No.1371 每个元音包含偶数次的最长子字符串</a></li><li><a href="/algorithm/2020-05/2020-05-21.html" class="sidebar-link">2020/5/21 No.5 最长回文子串</a></li><li><a href="/algorithm/2020-05/2020-05-22.html" class="sidebar-link">2020/5/22 No.105 从前序与中序遍历序列构造二叉树</a></li><li><a href="/algorithm/2020-05/2020-05-23.html" class="sidebar-link">2020/5/23 No.76 最小覆盖子串</a></li><li><a href="/algorithm/2020-05/2020-05-24.html" class="sidebar-link">2020/5/24 No.4 寻找两个正序数组的中位数</a></li><li><a href="/algorithm/2020-05/2020-05-25.html" class="sidebar-link">2020/5/25 No.146 LRU缓存机制</a></li><li><a href="/algorithm/2020-05/2020-05-26.html" class="sidebar-link">2020/5/26 No.287 寻找重复数</a></li><li><a href="/algorithm/2020-05/2020-05-27.html" class="sidebar-link">2020/5/27 No.974 和可被 K 整除的子数组</a></li><li><a href="/algorithm/2020-05/2020-05-28.html" class="sidebar-link">2020/5/28 No.394 字符串解码</a></li><li><a href="/algorithm/2020-05/2020-05-29.html" class="sidebar-link">2020/5/29 No.198 打家劫舍</a></li><li><a href="/algorithm/2020-05/2020-05-30.html" class="sidebar-link">2020/5/30 No.84 柱状图中最大的矩形</a></li><li><a href="/algorithm/2020-05/2020-05-31.html" class="sidebar-link">2020/5/31 No.101 对称二叉树</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/algorithm/2020-06/" class="sidebar-heading clickable"><span>2020-06</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/algorithm/2020-07/" class="sidebar-heading clickable"><span>2020-07</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/interviewCoding/" class="sidebar-heading clickable"><span>面试常见代码题</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/interviewCoding/深拷贝.html" class="sidebar-link">深拷贝</a></li><li><a href="/interviewCoding/数组对象去重.html" class="sidebar-link">数组对象去重</a></li><li><a href="/interviewCoding/背包问题.html" class="sidebar-link">背包问题</a></li><li><a href="/interviewCoding/二分查找.html" class="sidebar-link">二分查找</a></li><li><a href="/interviewCoding/扁平化.html" class="sidebar-link">扁平化</a></li><li><a href="/interviewCoding/柯里化函数.html" class="sidebar-link">柯里化函数</a></li><li><a href="/interviewCoding/排序算法.html" class="sidebar-link">排序算法</a></li><li><a href="/interviewCoding/驼峰下划线转换.html" class="sidebar-link">驼峰下划线转换/下划线转换驼峰</a></li><li><a href="/interviewCoding/序列化与反序列化.html" class="sidebar-link">序列化与反序列化</a></li><li><a href="/interviewCoding/防抖节流.html" class="sidebar-link">防抖节流</a></li><li><a href="/interviewCoding/改变this指向.html" class="sidebar-link">apply/call/bind</a></li><li><a href="/interviewCoding/Object.create.html" class="sidebar-link">Object.create</a></li><li><a href="/interviewCoding/promise.html" class="sidebar-link">promise</a></li><li><a href="/interviewCoding/Promise.all.html" class="sidebar-link">Promise.all</a></li><li><a href="/interviewCoding/promise化ajax.html" class="sidebar-link">promise化ajax</a></li><li><a href="/interviewCoding/reduce.html" class="sidebar-link">reduce</a></li><li><a href="/interviewCoding/发布订阅者模式.html" class="sidebar-link">发布订阅者模式</a></li><li><a href="/interviewCoding/手写Event类.html" class="sidebar-link">手写Event类</a></li><li><a href="/interviewCoding/jsonp.html" class="sidebar-link">jsonp</a></li><li><a href="/interviewCoding/for-of对象.html" class="sidebar-link">for-of对象</a></li><li><a href="/interviewCoding/三栏布局.html" class="sidebar-link">三栏布局</a></li><li><a href="/interviewCoding/new的实现.html" class="sidebar-link">new的实现</a></li><li><a href="/interviewCoding/instanceof原理.html" class="sidebar-link">instanceof原理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>[TOC]</p> <h1 id="nest-里的单元测试"><a href="#nest-里的单元测试" class="header-anchor">#</a> nest 里的单元测试</h1> <p>随着每个工程的复杂化、代码的高复用性要求和前端代码模块之间的高内聚低耦合的需求，前端工程中的单元测试流程显得越来越重要。</p> <h2 id="测试是什么"><a href="#测试是什么" class="header-anchor">#</a> 测试是什么</h2> <p>对于前端开发过程来说，这里的特定目标就是指我们写的代码，而工具就是我们需要用到的测试框架(库)、测试用例等。</p> <p>检测处的结果就是展示测试是否通过或者给出测试报告，这样才能方便问题的排查和后期的修正。</p> <p>基于测试“是什么”的说法，为便于像我一样的新手理解，列出单元测试它“不是什么”</p> <ul><li>需要访问数据库的测试不是单元测试（对数据库的增删改查）</li> <li>需要网络的测试不是单元测试（调用 api）</li> <li>需要访问文件系统的测试不是单元测试
上面说的这些，都可以通过 mock 来进行。</li></ul> <h2 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h2> <p>接下里写一个简单例子来示范 jest 里如何写一个简单的单元测试。</p> <p><code>user.service.ts</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个 service 就只有一个查询人员信息的方法，接下来我们写测试用例。</p> <p>在 nest 里，保持你的测试文件测试类附近。测试文件必须以 .spec 或 .test 结尾。</p> <p><code>user.service.spec.ts</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Test<span class="token punctuation">,</span> TestingModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/testing&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./user.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./user.entity&quot;</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&quot;./../user/user.entity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> id<span class="token punctuation">;</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;UserService&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> service<span class="token operator">:</span> UserService<span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> module<span class="token operator">:</span> TestingModule <span class="token operator">=</span> <span class="token keyword">await</span> Test<span class="token punctuation">.</span><span class="token function">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      imports<span class="token operator">:</span> <span class="token punctuation">[</span>UserService<span class="token punctuation">]</span><span class="token punctuation">,</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span>UserService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    service <span class="token operator">=</span> module<span class="token punctuation">.</span>get <span class="token operator">&lt;</span> UserService <span class="token operator">&gt;</span> UserService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;getUserById&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//code</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Test 类有一个 createTestingModule() 方法，该方法将模块的元数据（与在 @Module() 装饰器中传递的对象相同的对象）作为参数。这个方法创建了一个 TestingModule 实例，可以理解为创建一个 module，与你自己写的 user.module.ts 类似，该实例提供了一些方法，但是当涉及到单元测试时，这些方法中只有 compile() 是有用的。这个方式是异步的，因此必须等待执行完成。一旦模块编译完成，您可以使用 get() 方法检索任何实例，例如获取 service。</p> <p>之前提过，我们的 user.service.ts 只有一个查询数据库的方法，但是单元测试不会真的去查，这里我们 mock 一下我们的数据库，并创建一个新的用户。</p> <p>接下来是方法的具体实现。</p> <p><code>user.service.ts</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;	getUserById&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;getUserById&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    User<span class="token punctuation">.</span>findOne <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> service<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们 mock 了数据库的 findOne 这个方法，当 id 和查询的 id 一致，那么正确。当执行 service.getUserById(id) 这个方法时，里面的 findOne 方法就会替换成我们 mock 的方法。</p> <p>下面在写一个带 http 请求的单元测试。</p> <p><code>auth.service.ts</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> HttpService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/jwt'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../user/user.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> readonly httpService<span class="token operator">:</span> HttpService<span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly jwtService<span class="token operator">:</span> JwtService<span class="token punctuation">,</span>
    <span class="token keyword">private</span> readonly userService<span class="token operator">:</span> UserService<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">token<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TEST_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/v6/token/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?orgId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TEST_ORG_ID</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>httpService<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtService<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">validateUser</span><span class="token punctuation">(</span><span class="token parameter">staffId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里面有 3 个方法：</p> <ul><li>getUserInfo 发送 http 请求获取用户信息</li> <li>generateToken 生成 token</li> <li>validateUser 验证用户
这里不仅用了 httpService 还有 jwtService，比较复杂。</li></ul> <p><code>auth.service.spec.ts</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Test<span class="token punctuation">,</span> TestingModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/testing&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./auth.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@nestjs/jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../user/user.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./../user/user.entity&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AxiosResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;axios&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">of</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rxjs&quot;</span><span class="token punctuation">;</span>

jest<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&quot;./../user/user.entity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> result<span class="token operator">:</span> AxiosResponse<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  status<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  statusText<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  config<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;AuthService&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> authService<span class="token operator">:</span> AuthService<span class="token punctuation">;</span>
  <span class="token keyword">let</span> jwtService<span class="token operator">:</span> JwtService<span class="token punctuation">;</span>
  <span class="token keyword">let</span> httpService<span class="token operator">:</span> HttpService<span class="token punctuation">;</span>
  <span class="token keyword">let</span> userService<span class="token operator">:</span> UserService<span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> module<span class="token operator">:</span> TestingModule <span class="token operator">=</span> <span class="token keyword">await</span> Test<span class="token punctuation">.</span><span class="token function">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          provide<span class="token operator">:</span> JwtService<span class="token punctuation">,</span>
          useValue<span class="token operator">:</span> <span class="token punctuation">{</span>
            sign<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          provide<span class="token operator">:</span> UserService<span class="token punctuation">,</span>
          useValue<span class="token operator">:</span> <span class="token punctuation">{</span>
            getUserById<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          provide<span class="token operator">:</span> HttpService<span class="token punctuation">,</span>
          useValue<span class="token operator">:</span> <span class="token punctuation">{</span>
            get<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        AuthService<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    authService <span class="token operator">=</span> module<span class="token punctuation">.</span>get <span class="token operator">&lt;</span> AuthService <span class="token operator">&gt;</span> AuthService<span class="token punctuation">;</span>
    jwtService <span class="token operator">=</span> module<span class="token punctuation">.</span>get <span class="token operator">&lt;</span> JwtService <span class="token operator">&gt;</span> JwtService<span class="token punctuation">;</span>
    httpService <span class="token operator">=</span> module<span class="token punctuation">.</span>get <span class="token operator">&lt;</span> HttpService <span class="token operator">&gt;</span> HttpService<span class="token punctuation">;</span>
    userService <span class="token operator">=</span> module<span class="token punctuation">.</span>get <span class="token operator">&lt;</span> UserService <span class="token operator">&gt;</span> UserService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;getUserInfo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;getUserInfo&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//code here</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;generateToken&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;generateToken&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//code here</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;validateUser&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;validateUser&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//code here</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在单元测试中，我们不需要真的进行 http 请求、jwt 签证等操作，因此在 providers 中，我们对相应的 service 进行了 mock，mock 相应的方法。</p> <p>接下来对每个方法进行详细的解释。</p> <p><code>getUserInfo</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;getUserInfo&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;getUserInfo&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token string">&quot;e62abf0d-cc84-11ea-a7d5-ba49bd613097&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> testUrl <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>user<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>httpService<span class="token punctuation">,</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      testUrl <span class="token operator">=</span> url<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> userInfo <span class="token operator">=</span> <span class="token keyword">await</span> authService<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>testUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TEST_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/v6/token/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?orgId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TEST_ORG_ID</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchObject</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在 getUserInfo 这个方法中，传入一个 token，然后会进行 http 请求，其中这个请求的 url 是要拼接而成，因此这里需要进行验证 url 是否正确，然后对返回的数据是否匹配我们所需要的格式。</p> <p><code>generateToken</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;generateToken&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;generateToken&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    id <span class="token operator">=</span> user<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">let</span> jwtPayload<span class="token operator">:</span> object<span class="token punctuation">;</span>
    jest
      <span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>jwtService<span class="token punctuation">,</span> <span class="token string">&quot;sign&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">string</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        jwtPayload <span class="token operator">=</span> payload<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;token&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token keyword">await</span> authService<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>jwtPayload<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toStrictEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在生成 token 这个方法中，我们调用了 jwtService 里的 sign 这个方法，因此我们对其进行 mock。然后这里只要测试 payload 是否是我们所期望的结构。对于 token，因为生成的是一个随机的，因此只需进行相应的判断即可。</p> <p><code>validateUser</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;validateUser&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;validateUser&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>userService<span class="token punctuation">,</span> <span class="token string">&quot;getUserById&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> user<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在 validateUser 中，我们主要是调用 userService 获取用户信息，以判断是否是正确 id。这里和 userService 里调用数据库不一样，我们只需要 mock userService 的方法即可，不用过深。</p> <p>以上是最近写单元测试用例的一些总结，还不够完善，可能存在问题，后续在进行相应研究。</p> <!----></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/work/入职.html" class="prev">
        入职
      </a></span> <span class="next"><a href="/work/single-spa.html">
        single-spa浅析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.251be91f.js" defer></script><script src="/assets/js/3.c83a7086.js" defer></script><script src="/assets/js/133.0af77430.js" defer></script>
  </body>
</html>
